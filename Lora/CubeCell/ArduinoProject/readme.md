
# CubeCell Module - Sending Data to TTN

This document provides a step-by-step guide to configure and program the CubeCell module to send data to The Things Network (TTN) platform.

## Table of Contents
1. [Arduino IDE Setup](#arduino-ide-setup)
2. [Code Overview](#code-overview)
3. [Hardware Setup](#hardware-setup)
4. [TTN Configuration](#ttn-configuration)

---

## Arduino IDE Setup

To program the CubeCell module, use the Arduino IDE. Follow these steps to set up the environment:

1. Open the Arduino IDE.
2. Go to **File > Preferences**.
3. In the **Additional Boards Manager URLs** field, add the following URL:
   ```
   https://github.com/HelTecAutomation/CubeCell-Arduino/releases/download/V1.5.0/package_CubeCell_index.json
   ```
4. Install the CubeCell board through the **Boards Manager**:
   ```
   CubeCell Development Framework by Heltec...1.5.0 installed
   ```
5. Under the **Boards** select CubeCell Development Kit and then CubeCell-Board-V2 HTCC-AB01-V2
6. Copy **TransmitPacketTTN.ino** and compile it using Arduino IDE.
7. Check your setting under **Tools**. Make sure you r setting is similar to the figure below:

![image](https://github.com/user-attachments/assets/597f3bd8-89dc-45a0-8ebe-fda1899541d0)

9. Make sure the code compiles. If the code compiles properly, you should get something like this: 
```
Sketch uses 72244 bytes (55%) of program storage space. Maximum is 131072 bytes.
Initialising bootloader.
Silicon ID 0x256a11b5, revision 0.
Verifying rows.
Array 0: first row 34, last row 511.
Starting upload.
Uploading  ( 10 / 100 )
....
Uploading  ( 100 / 100 )
Checksum verifies OK.
Rebooting.
Total upload time 11.28s    
```
11. In the code you need to change the following:
```
   uint8_t appKey[] = {0xB6,0x4B,0xC7,0x69,0x87,0x1E,0xD6,0xDB,0x48,0x9D,0x97,0x05,0x3A,0xA5,0x2D,0x59 }; // From TTN
```
   The appKey is generated by TTN.  Comtinue to the next section. Obtain your keyApp and replace it with the one in the code for proper operation. 
11. 

## Code Overview

This code generates random data, which is defined in the `loop()` function. The random data is sent to TTN using the `LoRaWAN.send()` function.

- **Data Transmission:** Data is sent when the switch connected to GPIOI0 is pressed.
- **Switch Configuration:** The switch is set to active HIGH.

To modify data formats or frequency of data transmission, adjust the code in the `loop()` function as required.

## Hardware Setup

1.If you are using the **TransmitPktTTN_Switch.ion** you need to connect the switch to your board: Connect a switch to **GPIOI0**. Ensure the switch is configured to be active HIGH.

## TTN Configuration

To receive data from the CubeCell module on the TTN platform, configure your TTN application:

1. Create a new TTN application if you havenâ€™t already.

  <img width="587" alt="image" src="https://github.com/user-attachments/assets/ccb96cf3-f3b8-4581-b114-0e14608eb1bb">

2. You now need to register your new device (CubeCell). Follow the steps below:

- Make sure you have ocnnected the antenna to your CubeCell device. 
- Go to Application --> End Device --> Register End Device:
- Click on **Enter end device specifics manually** and enter parameters as shown here.
   - End device ID: cubecell-node-dd1
   - Frequency plan: United States 902-928 MHz, FSB 2 (used by TTN)
   - LoRaWAN version: LoRaWAN Specification 1.0.2
   - Regional Parameters version: RP001 Regional Parameters 1.0.2 revision B
   - Enter 00000000 for Join EUI and CONFIRM.
   - Click on GENERATE to obtain DevEUI and AppKey.
   - Note that AppEUI remains 000000.
   - Type a name for your End Device ID and click on Register Device.
   - Use the obtained DevEUI and AppKey in your code. Make sure you copy them before you press **Register End Device**. Place these values in your code. Pay attention to the format :

![image](https://github.com/user-attachments/assets/9885c30c-769a-4920-8e54-d390334a9bfb)

3. Configure the **Data Format** in TTN to match the way data is structured in the CubeCell code:
- In TTN select **Application**, then Select the device that you just created.
- Click on **Payload Formatter** and copy the code below in there.
   - Make sure the **Fprmatter Type** is Custom Javascript.
   - Make sure **fPort** is 1.
```
  function decodeUplink(input, port) {
  if (input.fPort===1) // Real-time performance
    return {
    data: {
      NodeId: (input.bytes[0]<<24 | input.bytes[1]<<16 | input.bytes[2]<<8 | input.bytes[3]),
      Temp45: (input.bytes[4]<<8 | input.bytes[5])/10,
      Temp6: (input.bytes[6]),
      Temp7: (input.bytes[7]),
      Temp89: (input.bytes[8]<<8 | input.bytes[9])/100
    }
  };
  }
   ```
<img width="1120" alt="image" src="https://github.com/user-attachments/assets/d7108c08-c6c8-4510-ad12-0bf63aca9e63">

![image](https://github.com/user-attachments/assets/68a8e118-ce9c-4a13-bf6c-71492beb8c91)

4. After pasting the DevEUI and AppKey in your code make sure you recompile the code Go back to TTN and check if the device has been connected:
- In TTN select **Application**, then Select the device that you just created.
- Click on **Live Data** and you should see something like this every 20 seconds:

![image](https://github.com/user-attachments/assets/9e59385d-c442-4702-8a01-90acf545bbfb)

5. If you would like to setup a gateway, got to Gateway, click on **+Register Gateway**,  add your gateway's **EUI**, and then set you your new gateway similar to below. When you are done click on Register:
![image](https://github.com/user-attachments/assets/5a95ebf6-9452-464e-84ea-bb8781e75f6d)


-------------
