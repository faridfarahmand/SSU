
# CubeCell Module - Sending Data to TTN

This document provides a step-by-step guide to configure and program the CubeCell module to send data to The Things Network (TTN) platform.

## Table of Contents
2. [Arduino IDE Setup](#arduino-ide-setup)
3. [Code Overview](#code-overview)
4. [Hardware Setup](#hardware-setup)
5. [Signing for TTN Account](#Signing-for-TTN-Account)
6. [TTN Configuration](#ttn-configuration)
7. [Adding a Gateway to the TTN](#Adding-a-Gateway-to-the-TTN)
8. [Retrieving the Data from TTN Using Python](#Retrieving-the-Data-from-TTN-Using-Python)

---
## Arduino IDE Setup

To program the CubeCell module, use the Arduino IDE. Follow these steps to set up the environment:

1. Open the Arduino IDE.
2. Go to **File > Preferences**.
3. In the **Additional Boards Manager URLs** field, add the following URL:
   ```
   https://github.com/HelTecAutomation/CubeCell-Arduino/releases/download/V1.5.0/package_CubeCell_index.json
   ```
4. Install the CubeCell board through the **Boards Manager**:
   ```
   CubeCell Development Framework by Heltec...1.5.0 installed
   ```
5. Under the **Boards** select CubeCell Development Kit and then CubeCell-Board-V2 HTCC-AB01-V2
6. Copy **TransmitPacketTTN.ino** and compile it using Arduino IDE.
7. Check your setting under **Tools**. Make sure you r setting is similar to the figure below:

![image](https://github.com/user-attachments/assets/597f3bd8-89dc-45a0-8ebe-fda1899541d0)

9. Make sure the code compiles. If the code compiles properly, you should get something like this: 
```
Sketch uses 72244 bytes (55%) of program storage space. Maximum is 131072 bytes.
Initialising bootloader.
Silicon ID 0x256a11b5, revision 0.
Verifying rows.
Array 0: first row 34, last row 511.
Starting upload.
Uploading  ( 10 / 100 )
....
Uploading  ( 100 / 100 )
Checksum verifies OK.
Rebooting.
Total upload time 11.28s    
```
11. In the code you need to change the following:
```
   uint8_t appKey[] = {0xB6,0x4B,0xC7,0x69,0x87,0x1E,0xD6,0xDB,0x48,0x9D,0x97,0x05,0x3A,0xA5,0x2D,0x59 }; // From TTN
```
   The appKey is generated by TTN.  Continue to the next section. Obtain your keyApp and replace it with the one in the code for proper operation. 

## Code Overview

The **TransmitPacketTTN.ino** code you downloaded generates random data, which is defined in the `loop()` function. The random data is sent to TTN using the `LoRaWAN.send()` function.

To modify data formats or frequency of data transmission, adjust the code in the `loop()` function as required.

## Hardware Setup

If you are using the **TransmitPktTTN_Switch.ion** code you need to connect the switch to your board: 

- Connect a switch to **GPIOI0**.
- Ensure the switch is configured to be active HIGH.

## Signing for TTN Account
TTN is an open source networking layer infrastructure that can be used for free and operates using The Things Stack (TTS). The Things Stack is an enterprise-grade LoRaWAN® Network Server that provides services and tools to securely install and manage millions of LoRaWAN devices in production [2].In addition, The Things Stack contains services and tools to securely manage millions of LoRaWAN devices in production [3]. TTN and TTS both support a wide range of user experience levels. For our work we only focus on using TTN. Therefore, we first need to create a TTN account: 
- Create a free account on TTN: https://www.thethingsnetwork.org/get-started?login
- Make sure you select and create an account with **The Things Network**

## TTN Configuration

For more information please refer to: https://docs.google.com/document/d/1CryTAEMZc1At7M9XHHKHM_6m0iK4PY0fzHtFIz939dM/edit?usp=sharing 

To receive data from the CubeCell module on the TTN platform, follow the following steps to configure your TTN application and add a device:

1. Create a new TTN application if you haven’t already. Follow the steps shown in the figure below. Include the **Application ID**, Name and description, as you prefer:

  <img width="587" alt="image" src="https://github.com/user-attachments/assets/ccb96cf3-f3b8-4581-b114-0e14608eb1bb">

2. You now need to register your new device (CubeCell). Follow the steps below:

- Make sure you have ocnnected the antenna to your CubeCell device. 
- Go to Application --> End Device --> Register End Device:
- Click on **Enter end device specifics manually** and enter parameters as shown below:
   - End device ID: cubecell-node-dd1 (or whatever you prefer)
   - Frequency plan: United States 902-928 MHz, FSB 2 (used by TTN)
   - LoRaWAN version: LoRaWAN Specification 1.0.2
   - Regional Parameters version: RP001 Regional Parameters 1.0.2 revision B
   - Enter 00000000 for Join EUI and CONFIRM.
   - Click on **GENERATE** to obtain DevEUI and AppKey.
   - Note that AppEUI remains 000000.
   - Type a name for your End Device ID and click on Register Device.
   - Use the obtained DevEUI and AppKey in your code. Make sure you copy them before you press **Register End Device**. Place these values in your code. Pay attention to the format :

![image](https://github.com/user-attachments/assets/9885c30c-769a-4920-8e54-d390334a9bfb)

3. Configure the **Data Format** in TTN to match the way data is structured in the CubeCell code:
- In TTN select **Application**, then Select the device that you just created.
- Click on **Payload Formatter** and copy the code below in there.
   - Make sure the **Fprmatter Type** is Custom Javascript.
   - Make sure **fPort** is 1.
```
  function decodeUplink(input, port) {
  if (input.fPort===1) // Real-time performance
    return {
    data: {
      NodeId: (input.bytes[0]<<24 | input.bytes[1]<<16 | input.bytes[2]<<8 | input.bytes[3]),
      Temp45: (input.bytes[4]<<8 | input.bytes[5])/10,
      Temp6: (input.bytes[6]),
      Temp7: (input.bytes[7]),
      Temp89: (input.bytes[8]<<8 | input.bytes[9])/100
    }
  };
  }
   ```

These steps are shown in the figure below: 

![image](https://github.com/user-attachments/assets/888d1a56-af12-43a8-8513-a1232380c396)

4. After pasting the DevEUI and AppKey in your code recompile the code. Make sure the code compiles.
5. Go back to TTN and check if the device has joined the TTN:
6. As soon as the device joins TTN, you should see a message similar to this:
   
![image](https://github.com/user-attachments/assets/3dc57b07-93d4-4bc8-84bf-0264ff15fce5)

- In TTN select **Application**, then Select the device that you just created.
- Click on **Live Data** and you should see something like this every 20 seconds:

![image](https://github.com/user-attachments/assets/9e59385d-c442-4702-8a01-90acf545bbfb)

7. Click on one of the received data lines. You will see teh details of each packet. Note the information such as
uplink data, SNR, location, RSSI, time stamp, received time, etc. It is important to note the difference between some of these parameters:
- "SNR" refers to the Signal-to-Noise Ratio, which indicates the strength of a received signal compared to background noise
- "RSSI" (Received Signal Strength Indicator) simply measures the raw signal strength received,
- "Channel RSSI" specifically refers to the RSSI value measured on the designated communication channel used by the device on TTN.

   ![image](https://github.com/user-attachments/assets/3bee3f2c-fb17-4089-acd3-51cabdbc2206)

## Adding a Gateway to the TTN

If you would like to setup a gateway, got to Gateway, click on **+Register Gateway**,  add your gateway's **EUI**, and then set you your new gateway similar to below. When you are done click on Register:
![image](https://github.com/user-attachments/assets/5a95ebf6-9452-464e-84ea-bb8781e75f6d)


## Retrieving the Data from TTN Using Python
Please refer to Section 4 of the main document: https://docs.google.com/document/d/1CryTAEMZc1At7M9XHHKHM_6m0iK4PY0fzHtFIz939dM/edit?usp=sharing  

